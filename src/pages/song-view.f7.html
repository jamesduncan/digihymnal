<template>
    <div class="page">
        <div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner sliding">
                <div class="left">
                    <a @click="backChecker" class="link">
                        <i class="icon icon-back"></i>
                        <span class="if-not-md">{{#if loading}}Back{{else}}{{translate "Back"}}{{/if}}</span>
                    </a>
                </div>
                <div class="title">
                    {{#if loading}}
                    {{else}}
                        {{song.title[defaultLanguage]}}

                    {{/if}}
                </div>
                <div class="right">
                    {{#if editMode}}
                        <a class="link icon-only edit-meta" href="{{#if loading}}{{else}}/song/edit/{{ @root.songId}}/{{/if}}">
                            <i class="text-color-lightgray fas fa-edit"></i>
                        </a>
                    {{/if}}
                </div>
            </div>
        </div>
        <div class="page-content hide-navbar-on-scroll">
            {{#if loading}}
            {{else}}
                <div class="block block-strong" style="margin-bottom: 10px; overflow: hidden;">
                    <div class="menu">
                        <div class="menu-inner no-margin-padding">
                            <a @click="zoomOut" class="menu-item icon-only">
                                <div class="menu-item-content">
                                    <i class="fa-bigger fas fa-search-minus"></i>
                                </div>
                            </a>
                            <a @click="zoomIn" class="menu-item icon-only">
                                <div class="menu-item-content">
                                    <i class="fa-bigger fas fa-search-plus"></i>
                                </div>
                            </a>
                            <!-- Stepper element -->
                            <div class="stepper stepper-large stepper-fill" style="display: none; margin-left: auto; height: 40px;">
                                <div class="stepper-button-minus"></div>
                                <div class="stepper-input-wrap">
                                    <input type="text" value="{{transpose song.key @root.steps}}" readonly>
                                </div>
                                <div class="stepper-button-plus"></div>
                            </div>
                            <div style="margin-left: auto" class="menu-item menu-item-dropdown">
                                <div class="menu-item-content icon-only">
                                    <div class="menu-item-content">
                                        <i class="fa-bigger fas fa-language"></i>
                                    </div>
                                </div>
                                <div class="menu-dropdown menu-dropdown-right">
                                    <div class="menu-dropdown-content">
                                        {{#each languages}}
                                            <a href="#" @click="toggleLyrics" data-language="{{tag}}" class="menu-dropdown-link menu-close">
                                                <span>{{#if local}}{{local}}{{else}}{{name}}{{/if}}</span>
                                                <i id="checkBox_{{tag}}" class="langCheckboxes margin-left {{#if default}}text-color-blue fas fa-adjust fa-rotate-90{{else}}text-color-gray far fa-circle{{/if}}"></i>
                                            </a>
                                        {{/each}}
                                    </div>
                                </div>
                            </div>
                            <div class="menu-item menu-item-dropdown">
                                <div class="menu-item-content icon-only">
                                    <div class="menu-item-content">
                                        <i class="fa-bigger fas fa-music"></i>
                                    </div>
                                </div>
                                <div class="menu-dropdown menu-dropdown-right">
                                    <div class="menu-dropdown-content">
                                        <a @click="toggleChords" class="menu-dropdown-link menu-close menuChords">
                                            <span>{{translate "Chords"}}</span>
                                            <i style="display: none;" class="margin-left text-color-primary fas fa-check-square"></i>
                                            <i class="margin-left text-color-gray far fa-square"></i>
                                        </a>
                                        <a @click="toggleNumbers" class="menu-dropdown-link menu-close menuNumbers">
                                            <span>{{translate "Number Notation"}}</span>
                                            <i style="display: none;" class="margin-left text-color-blue fas fa-check-circle"></i>
                                            <i class="margin-left text-color-gray far fa-circle"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="sheet">
                        <div class="song">
                            <div class="verse">
                                {{#each song.lyrics.verses}}
                                    <h3>{{#if label}}{{translate label}} 
                                        {{#if @root.editMode}}
                                            <a @click=deleteVerse({{@index}}) class="button button-small item-link edit-phrase"><i class="fas fa-bigger fa-dumpster-fire"></i></a>
                                            <a @click=copyChordsToVerse({{@index}}) class="button button-small item-link edit-phrase"><i class="fas fa-bigger fa-copy"></i></a>
                                        {{/if}}{{else}}<br />{{/if}} </h3>
                                    {{#each lines}}
                                        <div class="line">
                                            {{#if @root.editMode}}
                                                <!-- move chords -->
                                                <a href="/song/line/edit/{{ @root.songId}}/{{ ../../@index }}/{{@index}}/" class="button button-small item-link edit-phrase">
                                                    <span class="fa-stack fa-1x">
                                                        <i class="fas fa-bigger fa-music fa-stack-.5x" style="font-size: 0.80em;  vertical-align:top !important;"></i>
                                                        <i class="fas fa-arrows-alt-h fa-small fa-stack-1x" style="color:white; font-size: 0.85em; vertical-align:bottom !important;"></i>
                                                    </span>
                                                </a>
                                                <!-- edit line text -->
                                                <a @click=lineEditPopup({{../../@index}},{{@index}}) class="button button-small item-link edit-phrase"><i class="fas fa-bigger fa-edit"></i></a>
                                                <!-- delete line -->
                                                <a @click=deleteLine({{../../@index}},{{@index}}) class="button button-small item-link edit-phrase"><i class="fas fa-bigger fa-trash"></i></a>
                                                <!-- split verse -->
                                                <a  @click=splitVerse({{../../@index}},{{@index}}) class="button button-small item-link edit-phrase">
                                                    <span class="fa-stack fa-1x">
                                                        <i class="fas fa-bigger fa-file fa-stack-.5x"></i>
                                                        <i class="fas fa-minus fa-small fa-stack-1x" style="color:white;"></i>
                                                        <i class="fas fa-arrows-alt-v fa-small fa-stack-1x" style="color:white;"></i>
                                                    </span>
                                                </a> 
                                            {{/if}}
                                            {{#if this}}
                                                {{#each phrases}}
                                                    <div class="phrase {{#if @root.showNumber}}{{else}}noNumbers{{/if}} {{#if @root.showChord}}{{else}}noChords{{/if}}">
                                                        {{#if chord}}
                                                            {{#if @root.showChord}}
                                                                <div class="chord">{{transpose chord @root.steps}}</div>
                                                            {{/if}}
                                                        {{/if}}
                                                        {{#if number}}
                                                            {{#if @root.showNumber}}
                                                                <div class="number">{{number}}</div>
                                                            {{/if}}
                                                        {{/if}}
                                                        <div class="lyric">{{printObjectPropertyByKey this @root.lyric1 }}</div>  
                                                        {{#if @root.showLyric2}}
                                                            <div class="lyric">{{printObjectPropertyByKey this @root.lyric2 }}</div>
                                                        {{/if}}
                                                    </div>
                                                {{/each}}
                                            {{/if}}
                                            <div style="clear:both;"></div>
                                        </div>
                                    {{/each}}
                                    {{#if @root.editMode}}
                                    <a @click=addLine({{@index}}) class="button button-small item-link edit-phrase">
                                        <span class="fa-stack fa-1x">
                                            <i class="fas fa-language fa-file fa-stack-.5x"></i>
                                            <i class="fas fa-plus fa-small fa-stack-1x" style="color:white;"></i>
                                        </span>
                                    </a><a @click=addVerse({{@index}}) class="button button-small item-link edit-phrase">
                                        <span class="fa-stack fa-1x">
                                            <i class="fas fa-bigger fa-file fa-stack-.5x"></i>
                                            <i class="fas fa-plus fa-small fa-stack-1x" style="color:white;"></i>
                                        </span>
                                    </a><br>{{/if}}
                                {{/each}}
                            </div>
                            <div class="chorus">
                                {{#each song.lyrics.Chorus}}
                                    <h3>{{#if label}}{{translate label}}{{else}}<br />{{/if}}</h3>
                                    {{#each lines}}
                                        <div class="line">
                                            {{#each phrases}}
                                                <div class="phrase noNumbers">
                                                    {{#if chord}}
                                                        {{#if @root.showChord}}
                                                            <div class="chord">{{transpose chord @root.steps}}</div>
                                                        {{/if}}
                                                    {{/if}}
                                                    {{#if number}}
                                                        {{#if @root.showNumber}}
                                                            <div class="number">{{number}}</div>
                                                        {{/if}}
                                                    {{/if}}
                                                    <div class="lyric">{{this[lyric1]}}</div>
                                                    {{#if @root.showLyric2}}
                                                        <div class="lyric">{{this[lyric2]}}</div>
                                                    {{/if}}
                                                </div>
                                            {{/each}}
                                        </div>
                                    {{/each}}
                                {{/each}}
                            </div>
                            <div class="bridge">
                                {{#each song.lyrics.Bridge}}
                                    <h3>{{#if label}}{{translate label}}{{else}}<br />{{/if}}</h3>
                                    {{#each lines}}
                                        <div class="line">
                                            {{#each phrases}}
                                                <div class="phrase noNumbers">
                                                    {{#if chord}}
                                                        {{#if @root.showChord}}
                                                            <div class="chord">{{transpose chord @root.steps}}</div>
                                                        {{/if}}
                                                    {{/if}}
                                                    {{#if number}}
                                                        {{#if @root.showNumber}}
                                                            <div class="number">{{number}}</div>
                                                        {{/if}}
                                                    {{/if}}
                                                    <div class="lyric">{{this[lyric1]}}</div>
                                                    {{#if @root.showLyric2}}
                                                        <div class="lyric">{{this[lyric2]}}</div>
                                                    {{/if}}
                                                </div>
                                            {{/each}}
                                        </div>
                                    {{/each}}
                                {{/each}}
                            </div>
                        </div>
                    </div>
                </div>
                {{#js_if "@root.editMode && @root.savable"}}
                <p><a @click="save"  class="col popup-close button button-fill">*Save</a></p>
                {{/js_if}}
                <div class="block text-align-right text-color-gray" style="margin-top: 10px;">
                    {{song.author[defaultLanguage]}}
                </div>
            {{/if}}
        </div>
    </div>
</template>
<style>
    .no-margin-padding {
        margin: 0;
        padding: 0;
    }

    .fa-bigger {
        font-size: larger;
    }

    .song {
        transform-origin: left top;
    }

    .line {
        margin-bottom: 20px;
        display: block;
    }

    input {
        width: 100%;
        min-width: none !important;
        float: left;
        display: inline !important;
    }

    item-input-wrap {
        min-width: none !important;
        float: left;
        display: inline !important;
    }

    .lyrics {
        display: inline;
    }

    .phrase {
        position: relative;
        display: inline;
        margin: 55px 0 0 0;
        min-width: none !important;
        padding: 0px !important;
        float: left;
    }

    .chord,
    .number {
        top: -55px;
        background: var(--f7-theme-color);
        border-radius: 3px;
        min-width: 20px;
        max-width: 30px;
        height: 20px;
        line-height: 20px;
        text-align: center;
        color: white;
        font-weight: bold;
        display: inline-block;
        padding: 0 2px;
        margin-right: 5px;
        position: absolute;
        padding: 2px;
        transform: translateX(-50%);
    }

    .edit-phrase {
        float: left;
        margin: 10px 10px 0 -10px;
    }

    .number {
        top: -25px;
        border-radius: 100%;
        width: 20px;
        height: 20px;
        padding: 2px;
        background: var(--f7-color-blue);
        font-family: 'Notes', monospace;
    }

    .noNumbers,
    .noChords {
        margin-top: 30px !important;
    }

    .noNumbers.noChords {
        margin-top: 10px !important;
    }

    .noNumbers .chord,
    .noChords .chord {
        top: -30px;
    }
</style>
<script>
    self = this
    var songId
    var verseId
    var lineId
    var song
    var line
    var languages
    var app
    var phraseBreakLocations = {}
    var self
    var languageTags = [ ];
    var savable;
    import DataManager from '../data/dataManager';
    import Song from '../data/song';
    import Preference from "../data/preference";
    const preference = new Preference();

    // Import locales
    const locale = require('../js/locales.js');
    const dataManager = new DataManager();
    const songCollection = new Song();
    // songCollection.initSample();

    var initScale = 1;
    var lyric1;
    var lyric2;
    var defaultLanguage;
    var deviceWidth = window.innerWidth;
    if (deviceWidth >= 700) {
        initScale = 2;
    } else if (deviceWidth >= 500) {
        initScale = 1.5;
    }
    var steps = 0;

    export default {
        // Component Data
        data: function() {
            // Must return an object
            return {
                loading: true,
                savable: false,
                showNumber: false,
                showChord: false
            }
        },
        // Page Events
        on: {
            pageInit: function(e, page) {
                self = this;
                app = self.$app;
                songId = this.$route.params.songId;
                this.songId = songId;
                if(app.savable){
                    self.savableUpdate(true);
                } else {
                    self.savableUpdate(false);
                }

                preference.getEditMode().then((mode) => {
                    self.$setState({
                        editMode: mode
                    })
                });

                preference.getLanguage().then((languageCode) => {
                    lyric1 = languageCode;
                    defaultLanguage = languageCode;

                    // Get song from songCollection or from global var
                    if( !app.song || app.song.id != songId){
                        songCollection.get(songId).then(result => {
                            
                            song = result;
                            app.song = result;
                            updatePage(song);
                        });
                    } else { // else keep global var
                        song = app.song;
                        updatePage(song);
                    }
                    // update page with selected song
                    function updatePage(song,defaultLanguage){
                        var translationLangs = Object.keys(song.title);
                        languages = [];
                        locale.customLocales.forEach((item) => {
                            if (translationLangs.indexOf(item.tag) > -1) {
                                if (item.tag == lyric1) {
                                    item.default = true;
                                }                                
                                languages.push(item)
                                languageTags.push(item.tag)
                            }
                        });
                        self.$setState({
                            loading: false,
                            song: song,
                            lyric1: lyric1,
                            steps: steps,
                            languages: languages,
                            defaultLanguage: defaultLanguage
                        }, () => {
                            self.$(".song")[0].style.transform = "scale(" + initScale + ")";
                            self.$(".sheet")[0].style.height = (self.$(".song")[0].offsetHeight * initScale) + "px";
                            var stepper = app.stepper.create({
                                el: '.stepper',
                                value: steps,
                                min: 0,
                                max: 11,
                                wraps: true,
                                on: {
                                    change: function(e) {
                                        steps = e.value;
                                        self.$setState({
                                            steps: steps,
                                        });
                                    }
                                }
                            });
                        });
                    }
                });
            },
        },
        methods: {
            zoomIn: function(e) {
                initScale += 0.05;
                this.$(".song")[0].style.transform = "scale(" + initScale + ")";
                this.$(".sheet")[0].style.height = (this.$(".song")[0].offsetHeight * initScale) + "px";
            },
            zoomOut: function(e) {
                initScale -= 0.05;
                this.$(".song")[0].style.transform = "scale(" + initScale + ")";
                this.$(".sheet")[0].style.height = (this.$(".song")[0].offsetHeight * initScale) + "px";
            },
            toggleChords: function(e) {
                if (this.$(".menuChords .fa-check-square")[0].style.display == "") {
                    this.$setState({
                        showChord: false
                    });
                    this.$(".menuChords .fa-square")[0].style.display = "";
                    this.$(".menuChords .fa-check-square")[0].style.display = "none";
                    this.$(".phrase").addClass("noChords");
                    this.$(".stepper")[0].style.display = "none";
                    this.$(".sheet")[0].style.height = (this.$(".song")[0].offsetHeight * initScale) + "px";
                } else {
                    this.$setState({
                        showChord: true
                    });
                    this.$(".menuChords .fa-check-square")[0].style.display = "";
                    this.$(".menuChords .fa-square")[0].style.display = "none";
                    this.$(".phrase").removeClass("noChords");
                    this.$(".stepper")[0].style.display = "";
                    this.$(".sheet")[0].style.height = (this.$(".song")[0].offsetHeight * initScale) + "px";
                }
            },
            toggleNumbers: function(e) {
                if (this.$(".menuNumbers .fa-check-circle")[0].style.display == "") {
                    this.$setState({
                        showNumber: false
                    });
                    this.$(".menuNumbers .fa-circle")[0].style.display = "";
                    this.$(".menuNumbers .fa-check-circle")[0].style.display = "none";
                    this.$(".phrase").addClass("noNumbers");
                    this.$(".sheet")[0].style.height = (this.$(".song")[0].offsetHeight * initScale) + "px";
                } else {
                    this.$setState({
                        showNumber: true
                    });
                    this.$(".menuNumbers .fa-check-circle")[0].style.display = "";
                    this.$(".menuNumbers .fa-circle")[0].style.display = "none";
                    this.$(".phrase").removeClass("noNumbers");
                    this.$(".sheet")[0].style.height = (this.$(".song")[0].offsetHeight * initScale) + "px";
                }
            },
            toggleLyrics: function(e) {
                // get the language tag from the item tapped
                var languageTapped = e.currentTarget.dataset.language;

                // if the user tapped the language that is currently the default unset it
                if (lyric1 == languageTapped) {
                    lyric1 = "";
                } else if (lyric2 == languageTapped) {
                    lyric2 = ""; // if the user tapped the language that is currently the seconddary language unset it
                } else if (lyric1 != languageTapped && lyric2 != languageTapped) {
                    // if the user tapped a language that isn't displayed 
                    // set it to lyric1 if it isn't set anymore...otherwise set it as the secondary
                    if (lyric1 == "") {
                        lyric1 = languageTapped;
                    } else {
                        lyric2 = languageTapped;
                    }
                }

                this.$(".langCheckboxes").removeClass("text-color-blue fas fa-adjust fa-rotate-90 fa-rotate-270").addClass("text-color-gray far fa-circle");
                this.$("#checkBox_" + lyric1).removeClass("text-color-gray far fa-circle").addClass("text-color-blue fas fa-adjust fa-rotate-90");
                this.$("#checkBox_" + lyric2).removeClass("text-color-gray far fa-circle").addClass("text-color-blue fas fa-adjust fa-rotate-270");

                // is there a secondary language set?
                let showLyric2 = (lyric2 !== "") ? true : false;
                this.$setState({
                    lyric1: lyric1,
                    lyric2: lyric2,
                    showLyric2: showLyric2
                });
            },
            //
            addLine: function(selectedVerse,selectedLine) {
                // this supports inserting to middle of a verse, simply input a lineId...
                let newData = song;
                verseId = selectedVerse;
                lineId = selectedLine;
                // At index, add one element

                var phraseTemplate = Object.assign({}, newData.lyrics.verses[0].lines[0].phrases[0]);

                for (const tag in phraseTemplate) {
                    if (Object.hasOwnProperty.call(phraseTemplate, tag)) {
                        // set all data inside empty
                        phraseTemplate[tag] = "*"
                    }
                };

                let lineArray = newData.lyrics.verses[verseId].lines;
                let workingIndex = ++lineId; // tack it onto after current
                if(!selectedLine){
                    lineId = (newData.lyrics.verses[verseId].lines.length)
                    workingIndex = lineId;
                }
                let newLine = {'phrases': [phraseTemplate]};
                // insert item into arr at the specified index (deleting 0 items first, it's just an insert).
                lineArray.splice(workingIndex, 0, newLine);
                newData.lyrics.verses[verseId].lines = lineArray;

                song = newData;
                self.savableUpdate(true);
                self.$setState({
                    loading: false,
                    song: newData
                }, () => {
                    self.$(".song")[0].style.transform = "scale(" + initScale + ")";
                    self.$(".sheet")[0].style.height = (self.$(".song")[0].offsetHeight * initScale) + "px";
                });
            },  
            
            diacriticChecker: function(array, index) {
                if (!index) {index = 0};
                if (typeof(array)=='string') {
                    array = array.split("");
                }

                var nextIndex = index + 1
                if (nextIndex >= array.length) {
                    return array;
                }
                //if ([' ྱ', ' ེ', ' ོ', ].includes(array[nextIndex])){
                if ([4017, 3962, 3964, 3954].includes((array[nextIndex]).charCodeAt(0))) {
                    array[index] = array[index].concat(array.splice(nextIndex, 1)[0]);
                } else { // only increase if no diacritic
                    ++index;
                }
                return self.diacriticChecker(array, index);
            },
            lineEditPopup: function(selectedVerse,selectedLine) {
                var tag = defaultLanguage;
                verseId = selectedVerse;
                lineId = selectedLine;
                
                var langLine = ""
                if(!phraseBreakLocations[tag]){ // is is not set
                    phraseBreakLocations[tag] = [];
                }
                line = song.lyrics.verses[verseId].lines[lineId]
                line.phrases.forEach(phrase => {
                    if (phrase[tag]) {
                        langLine += phrase[tag];
                        let phraseArr = phrase[tag].split("")
                        let elementAsArray = self.diacriticChecker(phraseArr, 0);
                        phraseBreakLocations[tag].push(elementAsArray.length);
                    }
                });
  
                var el = `<div class="popup">
                        <div class="block">
                            <strong><h3>*edit line text here</h3></strong>
                            <div class='tag'>${tag}</div>
                            <form class="item-content item-input line-form" id="line-form">
                                <div class="item-inner">
                                    <div class="item-input-wrap" id="item-input-wrap">
                                    <input type="text" class="lineText" style=''value="${langLine}"/>
                                    <span class="input-clear-button"></span>
                                    </div>
                                </div>
                            </form>
                            <p><a  href="#" class="col popup-close button button-fill">*preview</a></p>
                        </div>
                    </div>`
                var a = app.popup.create({
                    content:el,
                    'tag': tag,  
                    closeByBackdropClick: true,
                    on: {
                        opened: function (popup) {
                        console.log('Panel opened')
                        },
                        opened: function (popup) {
                            console.log('Popup opened');
                        },
                        close: function (popup) {
                            var tag = self.$$(".tag")[0].innerHTML
                            var formData = self.$$(".lineText")[0].value
                            self.updateLine(formData, tag)
                        },
                    }
                }); 
                a.open();
            },
            updateLine: function(data,tag){
                if (self.validateTag(tag)){
                    //update line and refresh
                    var lineArr = self.diacriticChecker(data.split(""), 0)
                    var chordPlacment = phraseBreakLocations[tag]

                    let i = 0
                    while (i < line.phrases.length) {
                        let expectPhraseLength = chordPlacment[i];
                        // the array may be shorter than we expect, allow phrases to be at end of array
                        // at end of array, include any extra characters
                        // if exists,           is less than remaining length,           on last index, grab remainder => set. otherwise is remaining length. remaining length can be 0
                        let phraseLength = ((expectPhraseLength && expectPhraseLength < lineArr.length-1 && (i+1) < line.phrases.length) ? expectPhraseLength : (lineArr.length));
                        let newPhrase = lineArr.splice(0,phraseLength).join('');

                        //set it
                        line.phrases[i][tag] = newPhrase;
                        song.lyrics.verses[verseId].lines[lineId].phrases[i++][tag] = newPhrase;
                    }
                    self.savableUpdate(true);
                    self.$setState({
                        loading: false,
                        song: song,
                        line: line
                    });                   
                }
            },
            deleteLine: function(selectedVerse,selectedLine) {
                verseId = selectedVerse;
                lineId = selectedLine;
                var dialog = app.dialog.create({
                        backdrop: true,
                        closeByBackdropClick: false,
                        title: "<t>Delete this line?</t>",
                        buttons: [{
                                text: "<t>Yes</t>",
                                onClick: (dialog, ev) => {
                                    dialog.close();
                                    // pre-delete confirmation prompt
                                    let newData = song
                                    // At index, remove one element
                                    let deletedLine = newData.lyrics.verses[verseId].lines.splice(lineId, 1)
                    
                                    song = newData;
                                    app.song = newData;
                                    self.savableUpdate(true);
                                    self.$setState({
                                        song: newData,
                                        loading: false,
                                    }, () => {
                                        self.$(".song")[0].style.transform = "scale(" + initScale + ")";
                                        self.$(".sheet")[0].style.height = (self.$(".song")[0].offsetHeight * initScale) + "px";
                                    });
                                }
                            },
                            {
                                text: "<t>No</t>",
                                onClick: (dialog, ev) => {
                                    dialog.close();
                                }
                            }
                        ],
                        verticalButtons: true
                    });
                dialog.open();
            },
            addVerse: function(selectedVerse) {
                verseId = selectedVerse;
                let newData = song;
                var phraseTemplate = Object.assign({}, newData.lyrics.verses[0].lines[0].phrases[0]);
                for (const tag in phraseTemplate) {
                    if (Object.hasOwnProperty.call(phraseTemplate, tag)) {
                        // set all data inside empty
                        phraseTemplate[tag] = "*"
                    }
                };
                var lineObj = [{
                        'phrases': [phraseTemplate]
                    }]; // make a new template

                var currentVerse = newData.lyrics.verses[verseId];

                var newId = ((parseInt(currentVerse.id) !== NaN) ? (parseInt(currentVerse.id) + 1) : 1);

                // 'verse 3'
                let myArr = currentVerse.label.split(" ");
                let verseNumber = ( !isNaN(parseInt(myArr[(myArr.length - 1)])) ? ( (parseInt(myArr[(myArr.length - 1)])) + 1) : 1)

                var newLabel = 'verse '.concat(verseNumber);

                var newVerse = {
                    "lines": lineObj,
                    "label": newLabel,
                    "id": newId
                }

                // insert item into arr at the specified index (deleting 0 items first, it's just an insert).
                newData.lyrics.verses.splice(( verseId + 1 ) ,0,newVerse);
                
                // fix the ids
                var i = 0;
                newData.lyrics.verses.forEach(verse => {
                    verse['id'] = i++;
                });

                song = newData;
                app.song = newData;
                self.savableUpdate(true);
                self.$setState({
                    loading: false,
                    song: newData
                }, () => {
                    self.$(".song")[0].style.transform = "scale(" + initScale + ")";
                    self.$(".sheet")[0].style.height = (self.$(".song")[0].offsetHeight * initScale) + "px";
                });
            },
            copyChordsToVerse: function(selectedVerse) {
                verseId = selectedVerse;
                let newData = song;

                // source verse button options
                var buttonsArray = [{ text: "<t>Cancel</t>",
                            onClick: (dialog, ev) => {
                                dialog.close();
                            }}];
                song.lyrics.verses.forEach(verse => {
                    let elem = { text: `<t>${verse.label}</t>`,
                            onClick: (dialog, ev) => {
                                dialog.close();
                                readLines(verse.id)
                            }};
                    buttonsArray.push(elem);
                });
                // open popup, select verse to copy from
                var dialog = app.dialog.create({
                    backdrop: true,
                    closeByBackdropClick: false,
                    title: "<t>Select source verse</t>",
                    buttons: buttonsArray,
                    verticalButtons: true
                });
                dialog.open();

                // 
                function readLines(id){
                    var sourceV = song.lyrics.verses[id];
                    var destinationV = song.lyrics.verses[verseId]
                    // read chords from selected
                    var i = 0;
                    while ( i < sourceV.lines.length && i < destinationV.lines.length ) {
                        copyPhrase(sourceV.lines[i], destinationV.lines[i],verseId,i);
                        i++;
                    }
                }
                function copyPhrase(source,destination,verseId,lineId){
                    // source [{'en':'hey jude'},{'chord':'A','en':' play on piano man'}]
                    // destination [{'en':'Imagine a world'}, { 'en': 'without semicolons'}]

                    var chordList = []; // ['','A','B','C','D'];
                    var numberList = []; // ['','1','2','3','4'];
                    var sourcePercentList = { 'en': [.2,.3,.1,.4,0], 'at': [.3,.2,.2,.3,0] };
                    var sourceLen = { 'en': 10, 'at': 21 };
                    var sourceFullLine = {};
                    var phraseLengthList = {};

                    languageTags.forEach(lang => {
                        sourceFullLine[lang] = [];
                        sourceLen[lang] = 0;
                        phraseLengthList[lang] = [];
                        sourcePercentList[lang] = [];
                    });


                    source.phrases.forEach(phrase => {
                        if (!Object.hasOwnProperty.call(phrase, 'chord') ) {chordList.push('')}
                        if (!Object.hasOwnProperty.call(phrase, 'number') ) {numberList.push('');}

                        for (const key in phrase) {
                            if (Object.hasOwnProperty.call(phrase, key) && key) {
                                const element = phrase[key];
                                if( key == 'chord'){ 
                                    chordList.push(element);
                                }else if( key == 'number' ){
                                    numberList.push(element);
                                } else { // is language
                                    sourceFullLine[key] += element; // get full line
                                    sourceLen[key] = sourceFullLine[key].length; 

                                    // sourceFullLine = {'en': "hey jude", 'at': 'zxcvqewr'}
                                    phraseLengthList[key].push(self.diacriticChecker(element, 0).length) // (abc).length = 3
                                    //{'en': [1,2,3], 'at': [1,2,3] }
                                }
                            }
                        }
                    });
                    // Calculate percent for each tag: 'en': [.2,.3,.1,.4,0]
                    // for each tag:

                    // get approximate spacing from source
                    // [ab,cde,e,fghi]
                    // 20%, 30%, 10%, 40%
                    // total length / length of phrase (2/10 = .2) = aproxPLen

                    // totally combine destination, parse with diacritic checker
                    // [a,b,c,d,e,ae,f]
                    // destination.length * aproxPLen = how many char to put into phrase

                    languageTags.forEach(lang => {
                        phraseLengthList[lang].forEach(phraseLen => {
                            let ppercentage = phraseLen/sourceLen[lang]
                            sourcePercentList[lang].push(ppercentage);
                        });
                        var i = 0
                        var combinedLine = phraseCombiner(destination, lang);
                        var destinationArr = self.diacriticChecker(combinedLine, 0);
                        var destinationLength = destinationArr.length

                        while (i < chordList.length){
                            let chord = chordList[i];
                            let number = numberList[i];
                            let lengthGuess = Math.floor(sourcePercentList[lang][i] * destinationLength);
                            
                            let newData = destinationArr.splice(0, lengthGuess).join('');
                            if (i == chordList.length-1 ){
                                newData += destinationArr.join('')
                            }

                            if (destination.phrases[i] ){
                                destination.phrases[i][lang] = newData;
                            } else {
                                destination.phrases[i] = {}
                                destination.phrases[i][lang] = newData;
                            } 
                            destination.phrases[i]['chord'] = chord;
                            destination.phrases[i]['number'] = number;
                            i++;
                        }

                    });      
                    console.log (destination)
                    song.lyrics.verses[verseId].lines[lineId] = destination;
                }
                function phraseCombiner(line,tag){
                    var lineText = '';
                    line.phrases.forEach(phrase => {
                        if(phrase[tag]){
                            lineText += phrase[tag];
                        }
                    });
                    return lineText;
                }

                song = newData;
                app.song = newData;
                self.savableUpdate(true);
                self.$setState({
                    loading: false,
                    song: newData
                }, () => {
                    self.$(".song")[0].style.transform = "scale(" + initScale + ")";
                    self.$(".sheet")[0].style.height = (self.$(".song")[0].offsetHeight * initScale) + "px";
                });
            },
            splitVerse: function(selectedVerse,selectedLine) {
                // TODO offer option to copy chords from another existing verse
                verseId = selectedVerse;
                lineId = selectedLine;
                let newData = song;

                var currentVerse = newData.lyrics.verses[verseId];
                var newId = ((parseInt(currentVerse.id) !== NaN) ? (parseInt(currentVerse.id) + 1) : 1);

                // 'verse 3'
                let myArr = currentVerse.label.split(" ");
                let verseNumber = (!isNaN(parseInt(myArr[(myArr.length - 1)])) ? (parseInt(myArr[(myArr.length - 1)]))+1 : 1)
                var newLabel = 'verse '.concat(verseNumber);

                let toRemove = (currentVerse.lines.length - lineId) 
                var lineObj = currentVerse.lines.splice(lineId, toRemove);

                var newVerse = {
                    "lines": lineObj,
                    "label": newLabel,
                    "id": newId
                }

                //let newLine = {'phrases': [phraseTemplate]};
                let vArray = newData.lyrics.verses

                vArray.splice(verseId, 1, currentVerse); // overwrite current to be missing lines...

                vArray.splice(++verseId, 0, newVerse);// after current

                // fix the ids
                var i = 0;
                vArray.forEach(verse => {
                    verse['id'] = i++;
                });

                newData.lyrics.verses = vArray;
                song = newData;
                app.song = newData;

                self.savableUpdate(true);
                self.$setState({
                    loading: false,
                    song: newData
                }, () => {
                    self.$(".song")[0].style.transform = "scale(" + initScale + ")";
                    self.$(".sheet")[0].style.height = (self.$(".song")[0].offsetHeight * initScale) + "px";
                });
            },
            deleteVerse: function(selectedVerse){
                var dialog = app.dialog.create({
                    backdrop: true,
                    closeByBackdropClick: false,
                    title: "<t>Delete this verse?</t>",
                    buttons: [{
                        text: "<t>Yes</t>",
                        onClick: (dialog, ev) => {
                            dialog.close();
                            verseId = selectedVerse;
                            // TODO pre-delete confirmation prompt
                            let newData = song
                            // At index, remove one element
                            let deletedVerse = newData.lyrics.verses.splice(verseId, 1)
            
                            song = newData;
                            app.song = newData;                
                            self.savableUpdate(true);
                            self.$setState({
                                song: newData,
                                loading: false,
                            }, () => {
                                self.$(".song")[0].style.transform = "scale(" + initScale + ")";
                                self.$(".sheet")[0].style.height = (self.$(".song")[0].offsetHeight * initScale) + "px";
                            });
                        }
                        },
                        {
                            text: "<t>No</t>",
                            onClick: (dialog, ev) => {
                                dialog.close();
                            }
                        }
                        ],
                        verticalButtons: true
                    });
                dialog.open();
            },
            validateTag: function(tag){
                if (languageTags.includes(tag)){
                    return true;
                }
                debugger;
                return false
            },
            save: function(e) {
                songCollection.db.setItem(songId, song);
                self.savableUpdate(false)
                // send ovreall song changes to server
                dataManager.putSong(songId, song)
                    .then(responseText => alert(JSON.stringify(responseText)));
            },
            savableUpdate: function(bool) {
                if (typeof(bool) != 'boolean'){
                    bool = false;
                }
                app.savable = bool;
                savable = bool;
                self.$setState({
                    savable: bool
                });
            },
            backChecker: function(e) {
                // Check if there have been changes to the current song
                if (savable){
                    // prompt them to save>?
                    // 
                    var dialog = app.dialog.create({
                        backdrop: true,
                        closeByBackdropClick: false,
                        title: "<t>Leave this page?</t>",
                        text: "<t>Do you want to save your changes?</t>",
                        buttons: [{
                                text: "<t>Don't Save</t>",
                                onClick: (dialog, ev) => {
                                    app.song = {}
                                    this.$router.back();
                                }
                            },
                            {
                                text: "<t>Return and Save Changes</t>",
                                onClick: (dialog, ev) => {
                                    dialog.close();
                                }
                            }
                        ],
                        verticalButtons: true
                    });
                    dialog.open();
                    // If form is empty, go back immediately
                } else {
                    // just send them back
                    app.song = {};
                    app.saveable = false;
                    this.$router.back();
                }
            }
        }
    }
</script>